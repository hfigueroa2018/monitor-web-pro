<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Dashboard Monitor Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:40px;background:#f7f7f7;}
    h1,h2{color:#333;}
    .card{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
    .stat{font-size:24px;font-weight:bold;}
    .up{color:green}.down{color:red}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:8px;border:1px solid #ccc;text-align:center;}
    th{background:#eee}
    canvas{height:300px}
    #progressBar{width:100%;background:#eee;border-radius:4px;margin:10px 0;}
    #progress{height:20px;background:#4caf50;width:0%;border-radius:4px;transition:width .2s}
    select,button{padding:6px 10px;margin-right:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <h1>Dashboard de Monitoreo</h1>

  <!-- CONFIGURACIÓN -->
  <div class="card">
    <h2>Configuración</h2>
    <form id="configForm">
      <label>Frecuencia:
        <select id="freq">
          <option value="20">20 segundos</option>
          <option value="60">1 minuto</option>
          <option value="300">5 minutos</option>
          <option value="600">10 minutos</option>
          <option value="1800">30 minutos</option>
        </select>
      </label>
      <button type="button" id="btnStart">Iniciar monitoreo</button>
      <button type="button" id="btnStop">Detener monitoreo</button>
    </form>
    <p>Estado: <strong id="status">Detenido</strong></p>
  </div>

  <!-- AGREGAR SITIO -->
  <div class="card">
    <h2>Agregar sitio</h2>
    <form id="addForm">
      <input type="url" id="urlInput" placeholder="https://tusitio.com" required>
      <button type="submit">Agregar</button>
    </form>
  </div>

  <!-- TABLA DE SITIOS -->
  <div class="card">
    <h2>Sitios monitoreados</h2>
    <table>
      <thead>
        <tr><th>Sitio</th><th>Estado</th><th>Uptime 24h</th><th>Incidentes</th><th>Tiempo de respuesta</th><th>Acciones</th></tr>
      </thead>
      <tbody id="sitesTable"></tbody>
    </table>
  </div>

  <!-- GRÁFICO DE TIEMPOS DE RESPUESTA -->
  <div class="card">
    <h2>Tiempo de respuesta (última hora)</h2>
    <canvas id="responseChart"></canvas>
    <p id="noData" style="display:none;color:#777;margin-top:8px">No hay sitios configurados. Agrega uno para ver gráficos.</p>
  </div>

  <!-- BARRA ANIMADA (oculta por defecto) -->
  <div id="progressBar" style="display:none;">
    <div id="progress"></div>
  </div>
  <p id="result"></p>

  <script>
    let responseChart;
    let refreshTimer;

    async function getSites() {
      const res = await fetch("/sites");
      return res.ok ? res.json() : [];
    }
    async function getMetrics(url, days = 1) {
      const res = await fetch(`/metrics/${encodeURIComponent(url)}?days=${days}`);
      return res.ok ? res.json() : { uptime: 0, incidents: 0, response: { avg: 0, min: 0, max: 0 } };
    }
    async function getSeries(url, minutes = 60) {
      const res = await fetch(`/response-series/${encodeURIComponent(url)}?minutes=${minutes}`);
      return res.ok ? res.json() : [];
    }

    async function checkSiteNow(url) {
      const bar = document.getElementById("progressBar");
      const prog = document.getElementById("progress");
      const resText = document.getElementById("result");
      bar.style.display = "block";
      prog.style.width = "0%";
      resText.textContent = "Revisando...";
      for (let i = 0; i <= 100; i += 10) {
        prog.style.width = i + "%";
        await new Promise(r => setTimeout(r, 100));
      }
      const resp = await fetch("/check", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ url })
      });
      const data = await resp.json();
      resText.textContent = data.message;
      prog.style.backgroundColor = data.status === "ok" ? "#4caf50" : "#f44336";
      setTimeout(() => { bar.style.display = "none"; loadAll(); }, 1000);
    }

    async function loadAll() {
      const sites = await getSites();
      const tbody = document.getElementById("sitesTable");
      tbody.innerHTML = "";
      const noDataEl = document.getElementById("noData");
      if (!sites || sites.length === 0) {
        if (responseChart) { responseChart.destroy(); responseChart = null; }
        if (noDataEl) noDataEl.style.display = "block";
        return;
      } else {
        if (noDataEl) noDataEl.style.display = "none";
      }

      // destruir gráfico anterior
      if (responseChart) responseChart.destroy();

      // construir datasets con series temporales
      const datasets = [];
      let labelsSet = new Set();

      for (const site of sites) {
        const url = site.url || site;
        const m   = await getMetrics(url, 1);
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${url}</td>
          <td class="${m.incidents ? 'down' : 'up'}">${m.incidents ? '❌ Down' : '✅ Up'}</td>
          <td>${m.uptime_percent}%</td>
          <td>${m.incidents}</td>
          <td>${m.response.avg} ms</td>
          <td><button onclick="checkSiteNow('${url}')">Probar</button></td>
        `;

        let series = await getSeries(url, 1440);
        if (!series || series.length === 0) {
          const nowTs = new Date().toISOString();
          const hasAvg = m && m.response && typeof m.response.avg === 'number' && m.response.avg > 0;
          series = [{ time: nowTs, value: hasAvg ? m.response.avg : null, status: hasAvg ? 'up' : 'down' }];
        }
        // recolectar labels (timestamps) únicos
        series.forEach(p => labelsSet.add(p.time));
        // mapas: up -> valor real, down -> 0ms
        const mapUp = series.reduce((acc, p) => (acc[p.time] = (p.value ?? null), acc), {});
        const mapDown = series.reduce((acc, p) => (acc[p.time] = (p.value == null ? 0 : null), acc), {});
        datasets.push({
          label: `${url} (UP)`,
          data: mapUp,
          borderWidth: 2,
          spanGaps: false,
          borderColor: '#2e7d32',
          backgroundColor: 'rgba(46,125,50,0.2)'
        });
        datasets.push({
          label: `${url} (DOWN)`,
          data: mapDown,
          borderWidth: 2,
          spanGaps: false,
          borderColor: '#c62828',
          backgroundColor: 'rgba(198,40,40,0.2)'
        });
      }

      // ordenar labels cronológicamente
      const labels = Array.from(labelsSet).sort();

      // convertir datasets.data (mapa) a arreglo alineado con labels
      const chartDatasets = datasets.map(d => ({
        label: d.label,
        data: labels.map(ts => d.data[ts] ?? null),
        borderWidth: d.borderWidth,
        spanGaps: d.spanGaps,
        borderColor: d.borderColor,
        backgroundColor: d.backgroundColor,
        pointRadius: 2
      }));

      const ctx = document.getElementById("responseChart");
      responseChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: chartDatasets },
        options: {
          responsive: true,
          parsing: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'ms' } },
            x: { ticks: { autoSkip: true, maxTicksLimit: 8 } }
          }
        }
      });

      // refresco automático del gráfico cada 30s
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(async () => {
        await refreshChart();
      }, 30000);
    }

    async function refreshChart() {
      const sites = await getSites();
      let labelsSet = new Set();
      const seriesByUrl = {};

      for (const site of sites) {
        const url = site.url || site;
        const series = await getSeries(url, 1440);
        seriesByUrl[url] = series;
        series.forEach(p => labelsSet.add(p.time));
      }
      const labels = Array.from(labelsSet).sort();

      const newDatasets = (responseChart.data.datasets || []).map(ds => {
        // obtener URL base del label (quita sufijo " (UP)" o " (DOWN)")
        const urlBase = ds.label.replace(/ \(UP\)$| \(DOWN\)$/,'');
        const series = seriesByUrl[urlBase] || [];
        const mapUp = series.reduce((acc, p) => (acc[p.time] = (p.value ?? null), acc), {});
        const mapDown = series.reduce((acc, p) => (acc[p.time] = (p.value == null ? 0 : null), acc), {});
        const useMap = ds.label.endsWith('(DOWN)') ? mapDown : mapUp;
        return {
          ...ds,
          data: labels.map(ts => useMap[ts] ?? null)
        };
      });

      responseChart.data.labels = labels;
      responseChart.data.datasets = newDatasets;
      responseChart.update();
    }

    // ---------- CONFIG ----------
    document.getElementById("btnStart").onclick = async () => {
      const freq = document.getElementById("freq").value;
      await fetch("/config", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `action=start&freq=${freq}` });
      document.getElementById("status").textContent = "Monitoreando";
    };
    document.getElementById("btnStop").onclick = async () => {
      await fetch("/config", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: "action=stop&freq=60" });
      document.getElementById("status").textContent = "Detenido";
      if (refreshTimer) clearInterval(refreshTimer);
    };

    // ---------- AGREGAR SITIO ----------
    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const url = document.getElementById("urlInput").value.trim();
      if (!url) return;
      const res = await fetch("/add", { method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" }, body: `url=${encodeURIComponent(url)}` });
      if (res.ok) {
        document.getElementById("urlInput").value = "";
        await loadAll();
      } else {
        alert("Error al agregar sitio");
      }
    });

    // ---------- CARGA INICIAL ----------
    loadAll();
  </script>
</body>
</html>